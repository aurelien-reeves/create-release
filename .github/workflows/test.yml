name: Test

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Creates a Release for a fast-forwarded release branch
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up git config
        run: |
          git config --global user.email "github-actions@example.com"
          git config --global user.name "GitHub Actions"
          git checkout --orphan develop
      - run: touch CHANGELOG.md
      - name: Create a simple CHANGELOG
        uses: cucumber-actions/changelog-action@v1.3
        with:
          args: init --output CHANGELOG.md --compare-url https://example.com/abcdef...HEAD
      - name: Commit the CHANGELOG
        run: |
          git commit -am "Add a changelog"
      - name: Create a release in the CHANGELOG
        uses: cucumber-actions/changelog-action@v1.3
        with:
          args: release --output CHANGELOG.md 1.0.0
      - name: Commit the release
        run: |
          git commit -am "Release v1.0.0"
      - name: Create release branch
        run: |
          git checkout HEAD^
          git checkout -b release/test/v1.0.0
          git merge --ff-only develop 
          git push --force --set-upstream origin release/test/v1.0.0
      - name: Attempt to create Release
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Assert release exists
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release=$(gh release list | grep v1.0.0 | cut -f1)
          [ "$release" ]
          gh release delete $release
          git push origin :refs/heads/release/test/v1.0.0
